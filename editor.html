<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Mixmax &middot; Meeting Spot</title>

  <!-- Mixmax SDK -->
  <script defer src="https://d1xa36cy0xt122.cloudfront.net/v1/Mixmax.js"></script>

  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css?family=Josefin+Sans|Lobster" rel="stylesheet">
  <script src="//code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
  <script src="/lib/index.js"></script>
</head>

<body>

  <div class="app-popup">
  <h1 class="title">Let's meet in the middle</h1>
    <div class="toolbar__title  flex-fill">
      <form class="search">
        <div  class="location1-search">
          <input id="autocomplete" class="location1-search-field" placeholder="Enter Your location" onFocus="geolocate()" type="text" value=""></input>
        </div>
        
        <div class="location2-search">
          <input id="autocomplete2" class="location2-search-field" placeholder="Enter the other person's location" onFocus="geolocate()" type="text" value="">
        </div>
      </form>
    </div>
    
    <div id="search-results">
      <div id="map"></div>
    </div>
    
  </div>

  <script>
  
  function initialize() {
    initAutocomplete();
    initMap();
  }
  
  var autocomplete
  var autocomplete2
  var componentForm = {
    street_number: 'short_name',
    route: 'long_name',
    locality: 'long_name',
    administrative_area_level_1: 'short_name',
    country: 'long_name',
    postal_code: 'short_name'
  }

  function initAutocomplete() {
    autocomplete = new google.maps.places.Autocomplete(
        /** @type {!HTMLInputElement} */(document.getElementById('autocomplete')),
        { types: ['geocode']} )
    autocomplete2 = new google.maps.places.Autocomplete(
        /** @type {!HTMLInputElement} */(document.getElementById('autocomplete2')),
        { types: ['geocode']} )
    autocomplete.addListener('place_changed', function() {
      var location = $('.location1-search-field').val()
      new SetLocation('location1', location)
    }) 
    autocomplete2.addListener('place_changed', function() {
      var location = $('.location2-search-field').val()
      new SetLocation('location2', location)
    }) 
    
    class SetLocation {
      constructor(name, location) {
        this.name = name
        this.location = location
        this.findGeolocation()
      }
      
      findGeolocation() {
        const locationFormatted = this.formatAddress(this.location)
        this.findCoord(this.name, locationFormatted)
      }
      
      formatAddress(address) {
        const array = address.split(' ')
        const alteredArray = []
        for (var i = 0; i < array.length; i++) {
          alteredArray.push(array[i] + '+')
        }
        return alteredArray
      }
      
      findCoord(place, locationFormatted) {
        const apiKey = 'AIzaSyBpLUwZpzkUP48Yz_9WWbly35G7W-8YiN8'
        $.ajax({
          type: "GET",
          url: `https://maps.googleapis.com/maps/api/geocode/json?address=${locationFormatted}&key=${apiKey}`,
          success: data => success(place, data)
        })
        function success(place, data) {
          const response = data.results[0].geometry.location
          const coords = `lat:${response.lat}, lng:${response.lng}`
          localStorage.setItem(place, coords)
        }
      }
    }  
  }

    // Bias the autocomplete object to the user's geographical location,
    // as supplied by the browser's 'navigator.geolocation' object.
    function geolocate() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
          var geolocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          }
          var circle = new google.maps.Circle({
            center: geolocation,
            radius: position.coords.accuracy
          })
          autocomplete.setBounds(circle.getBounds())
        })
      }
    }

    var request;
    var service;
    var markers = [];

    function initMap() {
      var center = new google.maps.LatLng(37.422, -122.084058)
      map = new google.maps.Map(document.getElementById('map'), {
        center: center,
        zoom: 15
      });
      
      request = {
        location: center,
        radius: 01,
        type: ['cafe']
      }
  
      infowindow = new google.maps.InfoWindow();
      service = new google.maps.places.PlacesService(map);
      service.nearbySearch(request, callback);
      var centerControlDiv = document.createElement('div');
      var centerControl = new CenterControl(centerControlDiv, map);

      centerControlDiv.index = 1;
      map.controls[google.maps.ControlPosition.TOP_CENTER].push(centerControlDiv);
    }
      
      function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
          for (var i = 0; i < results.length; i++) {
            markers.push(createMarker(results[i]));
          }
        }
      }
    
      function createMarker(place) {
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location
        });
    
        google.maps.event.addListener(marker, 'click', function() {
          infowindow.setContent(place.name);
          infowindow.open(map, this);
        });
        return marker
      }
      
      function clearResults(markers) {
        for (var m in markers) {
          markers[m].setMap(null)
        }
        markers = []
      }
        
      function CenterControl(controlDiv, map) {
        // Set CSS for the control border.
        var controlUI = document.createElement('div');
        controlUI.style.backgroundColor = '#fff';
        controlUI.style.border = '2px solid #fff';
        controlUI.style.borderRadius = '3px';
        controlUI.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
        controlUI.style.cursor = 'pointer';
        controlUI.style.marginBottom = '22px';
        controlUI.style.textAlign = 'center';
        controlUI.title = 'Click to recenter the map';
        controlDiv.appendChild(controlUI);

        // Set CSS for the control interior.
        var controlText = document.createElement('div');
        controlText.style.color = 'rgb(25,25,25)';
        controlText.style.fontSize = '16px';
        controlText.style.lineHeight = '38px';
        controlText.style.paddingLeft = '5px';
        controlText.style.paddingRight = '5px';
        controlText.innerHTML = 'Find Coffee Shops';
        controlUI.appendChild(controlText);

        // Setup the click event listeners: simply set the map to Chicago.
        controlUI.addEventListener('click', function() {
          // midPoint() {
            const DEG_TO_RAD = Math.PI / 180;     // To convert degrees to radians.
            const latitude1 = localStorage.getItem('location1').split(',')[0].split(':')[1]
            const latitude2 = localStorage.getItem('location2').split(',')[0].split(':')[1]
            const longitude1 = localStorage.getItem('location1').split(',')[1].split(':')[1]
            const longitude2 = localStorage.getItem('location2').split(',')[1].split(':')[1]
            // Convert latitude and longitudes to radians:
            const lat1 = latitude1 * DEG_TO_RAD;
            const lat2 = latitude2 * DEG_TO_RAD;
            const lng1 = longitude1 * DEG_TO_RAD;
            const dLng = (longitude2 - longitude1) * DEG_TO_RAD;  // Diff in longtitude.
         
            // Calculate mid-point:
            const bx = Math.cos(lat2) * Math.cos(dLng);
            const by = Math.cos(lat2) * Math.sin(dLng);
            const latitude = Math.atan2(
                Math.sin(lat1) + Math.sin(lat2),
                Math.sqrt((Math.cos(lat1) + bx) * (Math.cos(lat1) + bx) + by * by));
            const longitude = lng1 + Math.atan2(by, Math.cos(lat1) + bx);
            const midPointLat = latitude / DEG_TO_RAD
            const midPointLng = longitude / DEG_TO_RAD
            localStorage.setItem('center', `${midPointLat},${midPointLng}`)
            console.log(latitude)
            console.log(longitude)
          // }
          var lat = Number(localStorage.getItem('center').split(',')[0])
          var lng = Number(localStorage.getItem('center').split(',')[1])
          var center = {lat: lat, lng: lng}
          map.setCenter(center)
          clearResults(markers)
    
          var request = {
            location: (center),
            radius: 1000,
            type: ['cafe']
          }
          service.nearbySearch(request, callback);
        });
      }

    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBpLUwZpzkUP48Yz_9WWbly35G7W-8YiN8&libraries=places&callback=initialize"
        async defer></script>

</body>
</html>